{% extends "base.html" %}
{% block title %}Comfy Bridge — Setup{% endblock %}
{% block body_class %}setup-page{% endblock %}
{% block nav %}{% endblock %}
{% block main_class %}setup-main{% endblock %}

{% block content %}
<div class="setup-container" x-data="setupWizard()">

  <!-- Header -->
  <div class="setup-header">
    <div class="setup-logo">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
    </div>
    <h1>Comfy Bridge</h1>
    <p class="setup-subtitle">Connect your ComfyUI to AI Power Grid</p>
  </div>

  <!-- Step indicators -->
  <div class="steps-bar">
    <div class="step-dot" :class="step >= 1 ? 'active' : ''">
      <span>1</span>
      <label>ComfyUI</label>
    </div>
    <div class="step-line" :class="step >= 2 ? 'active' : ''"></div>
    <div class="step-dot" :class="step >= 2 ? 'active' : ''">
      <span>2</span>
      <label>Grid API</label>
    </div>
    <div class="step-line" :class="step >= 3 ? 'active' : ''"></div>
    <div class="step-dot" :class="step >= 3 ? 'active' : ''">
      <span>3</span>
      <label>Launch</label>
    </div>
  </div>

  <!-- ========== STEP 1: ComfyUI ========== -->
  <div class="step-panel" x-show="step === 1" x-transition>
    <h2>Connect to ComfyUI</h2>
    <p class="step-desc">Comfy Bridge needs a running ComfyUI instance. We'll try to detect yours automatically.</p>

    <!-- Detection status -->
    <div class="detect-box" :class="detecting ? 'loading' : (detection.found ? 'success' : 'idle')">
      <template x-if="detecting">
        <div class="detect-status">
          <div class="spinner"></div>
          <span>Scanning for ComfyUI...</span>
        </div>
      </template>
      <template x-if="!detecting && detection.found">
        <div class="detect-status">
          <div class="status-icon success">&#10003;</div>
          <div>
            <strong>ComfyUI detected</strong>
            <div class="detect-detail" x-text="detection.base_path"></div>
            <div class="detect-methods">
              <template x-for="m in detection.methods" :key="m">
                <span class="tag" x-text="m"></span>
              </template>
            </div>
          </div>
        </div>
      </template>
      <template x-if="!detecting && !detection.found && detection.checked">
        <div class="detect-status">
          <div class="status-icon warn">!</div>
          <div>
            <strong>ComfyUI not detected</strong>
            <div class="detect-detail">You can set the URL manually or install ComfyUI below.</div>
          </div>
        </div>
      </template>
    </div>

    <!-- URL input -->
    <label class="field">
      <span class="field-label">ComfyUI URL</span>
      <div class="input-with-action">
        <input type="text" x-model="config.comfyui_url" placeholder="http://127.0.0.1:8188">
        <button type="button" class="btn btn-sm" @click="checkUrl()" :disabled="checking_url">
          <span x-show="!checking_url">Test</span>
          <span x-show="checking_url" class="spinner-sm"></span>
        </button>
      </div>
      <div class="field-hint" x-show="url_status === 'ok'" style="color: var(--green);">Connected</div>
      <div class="field-hint" x-show="url_status === 'fail'" style="color: var(--red);">Not reachable — is ComfyUI running?</div>
    </label>

    <!-- Base path -->
    <label class="field">
      <span class="field-label">ComfyUI Path <span class="optional">(for model downloads)</span></span>
      <input type="text" x-model="config.comfyui_base_path" placeholder="/home/user/ComfyUI">
    </label>

    <!-- Install ComfyUI (only shown when not detected) -->
    <div class="install-section" x-show="!detection.found">
      <div class="divider"><span>Install ComfyUI <span class="optional">(optional)</span></span></div>

      <!-- Step A: Need comfy-cli first -->
      <template x-if="!detection.comfy_cli_available">
        <div class="install-card">
          <p class="install-step-label">Step 1 — Install comfy-cli</p>
          <p class="field-hint" style="margin-bottom: 0.75rem;">comfy-cli is the official tool for installing and managing ComfyUI.</p>
          <button type="button" class="btn btn-outline" @click="installComfyCli()" :disabled="installing_cli">
            <span x-show="!installing_cli">Install comfy-cli</span>
            <span x-show="installing_cli"><span class="spinner-sm"></span> Installing comfy-cli...</span>
          </button>
          <div class="field-hint" x-show="cli_install_error" style="color: var(--red); margin-top: 0.4rem;" x-text="cli_install_error"></div>
          <div class="field-hint" x-show="cli_install_ok" style="color: var(--green); margin-top: 0.4rem;">comfy-cli installed</div>
          <p class="field-hint" style="margin-top: 0.5rem;">Or install manually: <code>pip install comfy-cli</code></p>
        </div>
      </template>

      <!-- Step B: comfy-cli available, can install ComfyUI -->
      <template x-if="detection.comfy_cli_available">
        <div class="install-card">
          <p class="install-step-label">
            Install ComfyUI via comfy-cli
            <span class="tag" style="margin-left: 0.4rem;" x-text="'using ' + detection.comfy_cli_path"></span>
          </p>
          <label class="field" style="margin-top: 0.75rem;">
            <span class="field-label">Install path <span class="optional">(leave blank for default)</span></span>
            <input type="text" x-model="comfyui_install_path" placeholder="e.g. ~/ComfyUI">
          </label>
          <button type="button" class="btn btn-outline" @click="installComfyUI()" :disabled="installing_comfyui">
            <span x-show="!installing_comfyui">Install ComfyUI</span>
            <span x-show="installing_comfyui"><span class="spinner-sm"></span> Installing... this may take a few minutes</span>
          </button>
          <div class="field-hint" x-show="comfyui_install_error" style="color: var(--red); margin-top: 0.4rem;" x-text="comfyui_install_error"></div>
          <div class="field-hint" x-show="comfyui_install_ok" style="color: var(--green); margin-top: 0.4rem;">ComfyUI installed. Don't forget to launch it: <code>comfy launch</code></div>
        </div>
      </template>

      <div style="margin-top: 0.5rem;">
        <button type="button" class="btn btn-sm btn-outline" @click="runDetect()">Re-detect</button>
      </div>
    </div>

    <div class="step-actions">
      <div></div>
      <button class="btn btn-primary" @click="step = 2">
        Next
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      </button>
    </div>
  </div>

  <!-- ========== STEP 2: Grid API ========== -->
  <div class="step-panel" x-show="step === 2" x-transition>
    <h2>AI Power Grid</h2>
    <p class="step-desc">Enter your Grid API key to start receiving generation jobs. <a href="https://aipowergrid.io" target="_blank" rel="noopener">Get an API key</a></p>

    <label class="field">
      <span class="field-label">API Key</span>
      <input type="password" x-model="config.api_key" placeholder="Your AI Power Grid API key">
    </label>

    <label class="field">
      <span class="field-label">Worker Name</span>
      <input type="text" x-model="config.worker_name" placeholder="my-comfyui-worker">
    </label>

    <label class="field">
      <span class="field-label">Models <span class="optional">(comma-separated, leave blank for auto-detect)</span></span>
      <input type="text" x-model="config.models" placeholder="e.g. FLUX.2 Klein 4B FP8">
    </label>

    <label class="field">
      <span class="field-label">Workflow Files <span class="optional">(comma-separated, leave blank for defaults)</span></span>
      <input type="text" x-model="config.workflow_file" placeholder="e.g. flux2_klein_4b_api.json">
    </label>

    <div class="step-actions">
      <button class="btn btn-outline" @click="step = 1">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        Back
      </button>
      <button class="btn btn-primary" @click="step = 3" :disabled="!config.api_key">
        Next
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      </button>
    </div>
  </div>

  <!-- ========== STEP 3: Launch ========== -->
  <div class="step-panel" x-show="step === 3" x-transition>
    <h2>Ready to Launch</h2>
    <p class="step-desc">Review your configuration and start the worker.</p>

    <div class="review-table">
      <div class="review-row">
        <span class="review-label">ComfyUI URL</span>
        <span class="review-value" x-text="config.comfyui_url"></span>
      </div>
      <div class="review-row" x-show="config.comfyui_base_path">
        <span class="review-label">ComfyUI Path</span>
        <span class="review-value" x-text="config.comfyui_base_path"></span>
      </div>
      <div class="review-row">
        <span class="review-label">Worker Name</span>
        <span class="review-value" x-text="config.worker_name || 'ComfyUI-Bridge-Worker'"></span>
      </div>
      <div class="review-row" x-show="config.models">
        <span class="review-label">Models</span>
        <span class="review-value" x-text="config.models"></span>
      </div>
      <div class="review-row" x-show="config.workflow_file">
        <span class="review-label">Workflows</span>
        <span class="review-value" x-text="config.workflow_file"></span>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn btn-outline" @click="step = 2">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        Back
      </button>
      <button class="btn btn-primary btn-launch" @click="completeSetup()" :disabled="launching">
        <template x-if="!launching">
          <span>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            Launch Worker
          </span>
        </template>
        <template x-if="launching">
          <span><div class="spinner-sm"></div> Starting...</span>
        </template>
      </button>
    </div>
  </div>

</div>

<script>
function setupWizard() {
  return {
    step: 1,
    detecting: true,
    detection: { found: false, checked: false, methods: [], comfy_cli_available: false, comfy_cli_path: null },
    config: {
      comfyui_url: '{{ detection.url or "http://127.0.0.1:8188" }}',
      comfyui_base_path: '{{ detection.base_path or "" }}',
      api_key: '',
      worker_name: '',
      models: '',
      workflow_file: '',
    },
    checking_url: false,
    url_status: null,
    // comfy-cli install
    installing_cli: false,
    cli_install_error: null,
    cli_install_ok: false,
    // ComfyUI install
    comfyui_install_path: '',
    installing_comfyui: false,
    comfyui_install_error: null,
    comfyui_install_ok: false,
    launching: false,

    async init() {
      await this.runDetect();
    },

    async runDetect() {
      this.detecting = true;
      try {
        const r = await fetch('/api/setup/detect', { method: 'POST' });
        const d = await r.json();
        d.checked = true;
        this.detection = d;
        if (d.found) {
          if (d.url) this.config.comfyui_url = d.url;
          if (d.base_path) this.config.comfyui_base_path = d.base_path;
          await this.checkUrl();
        }
      } finally {
        this.detecting = false;
      }
    },

    async checkUrl() {
      this.checking_url = true;
      this.url_status = null;
      try {
        const r = await fetch('/api/setup/check-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: this.config.comfyui_url }),
        });
        const d = await r.json();
        this.url_status = d.reachable ? 'ok' : 'fail';
      } finally {
        this.checking_url = false;
      }
    },

    async installComfyCli() {
      this.installing_cli = true;
      this.cli_install_error = null;
      this.cli_install_ok = false;
      try {
        const r = await fetch('/api/setup/install-comfy-cli', { method: 'POST' });
        const d = await r.json();
        if (d.ok) {
          this.cli_install_ok = true;
          // Re-detect so comfy_cli_available updates
          await this.runDetect();
        } else {
          this.cli_install_error = d.error;
        }
      } finally {
        this.installing_cli = false;
      }
    },

    async installComfyUI() {
      this.installing_comfyui = true;
      this.comfyui_install_error = null;
      this.comfyui_install_ok = false;
      try {
        const r = await fetch('/api/setup/install-comfyui', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            path: this.comfyui_install_path || null,
            comfy_bin: this.detection.comfy_cli_path || null,
          }),
        });
        const d = await r.json();
        if (d.ok) {
          this.comfyui_install_ok = true;
          await this.runDetect();
        } else {
          this.comfyui_install_error = d.error;
        }
      } finally {
        this.installing_comfyui = false;
      }
    },

    async completeSetup() {
      this.launching = true;
      try {
        const payload = {
          COMFYUI_URL: this.config.comfyui_url,
          GRID_API_KEY: this.config.api_key,
          GRID_WORKER_NAME: this.config.worker_name || 'ComfyUI-Bridge-Worker',
        };
        if (this.config.comfyui_base_path) payload.COMFYUI_BASE_PATH = this.config.comfyui_base_path;
        if (this.config.models) payload.GRID_MODEL = this.config.models;
        if (this.config.workflow_file) payload.WORKFLOW_FILE = this.config.workflow_file;

        const r = await fetch('/api/setup/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const d = await r.json();
        if (d.ok) {
          window.location.href = '/';
        }
      } finally {
        this.launching = false;
      }
    }
  }
}
</script>
{% endblock %}
